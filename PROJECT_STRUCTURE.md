# 项目结构文档

## 代码组织架构

### 📁 文件结构
```
src/
├── lib.rs          # 主入口文件，模块声明和导出
├── constants.rs    # PNG常量定义
├── crc.rs          # CRC计算模块
├── filter.rs       # PNG滤镜处理
├── bitmap.rs       # 位图处理模块
├── utils.rs        # 工具函数
└── png.rs          # PNG主结构体
```

### 🔧 模块职责

#### `lib.rs` - 主入口
- 模块声明和重新导出
- 兼容性函数
- WASM初始化

#### `constants.rs` - 常量定义
- PNG文件签名
- Chunk类型常量
- 颜色类型常量
- 滤镜类型常量
- 交错通道定义
- 工具函数

#### `crc.rs` - CRC计算
- CRC32计算表
- CRC校验和计算
- Chunk CRC验证
- 数据完整性检查

#### `filter.rs` - 滤镜处理
- Paeth预测器算法
- PNG滤镜应用
- 滤镜反向处理
- 最佳滤镜选择

#### `bitmap.rs` - 位图处理
- 位深度转换
- 调色板处理
- 透明度颜色处理
- 格式标准化
- RGBA转换

#### `utils.rs` - 工具函数
- 调试日志宏
- 数据类型转换
- 坐标验证
- 数组安全访问
- 交错计算

#### `png.rs` - PNG主结构
- PNG类实现
- PNGSync类实现
- 所有公共API方法
- 像素操作
- 图像处理

### 🎯 设计原则

#### 1. **单一职责原则**
每个模块只负责一个特定功能领域：
- `constants.rs` - 只包含常量定义
- `crc.rs` - 只处理CRC相关功能
- `filter.rs` - 只处理滤镜算法

#### 2. **模块化设计**
- 清晰的模块边界
- 最小化模块间依赖
- 易于测试和维护

#### 3. **可扩展性**
- 新功能可以独立添加
- 不影响现有模块
- 支持插件式扩展

#### 4. **性能优化**
- 零拷贝操作
- 内存高效
- 算法优化

### 📊 模块依赖图

```
lib.rs
├── constants.rs (独立)
├── crc.rs (独立)
├── filter.rs (依赖 constants.rs)
├── bitmap.rs (依赖 constants.rs)
├── utils.rs (独立)
└── png.rs (依赖所有其他模块)
```

### 🔄 数据流

```
输入数据 → png.rs → bitmap.rs → filter.rs → 输出数据
                ↓
            constants.rs (常量)
                ↓
            crc.rs (校验)
                ↓
            utils.rs (工具)
```

### 🚀 优势

#### 1. **可维护性**
- 代码结构清晰
- 功能模块化
- 易于调试

#### 2. **可测试性**
- 每个模块可独立测试
- 模拟依赖简单
- 测试覆盖率高

#### 3. **可扩展性**
- 新功能易于添加
- 不影响现有代码
- 支持增量开发

#### 4. **性能**
- 模块化编译优化
- 减少不必要的依赖
- 更好的内存管理

### 📝 开发指南

#### 添加新功能
1. 确定功能归属模块
2. 在对应模块中实现
3. 更新模块文档
4. 添加测试用例

#### 修改现有功能
1. 定位相关模块
2. 保持API兼容性
3. 更新相关文档
4. 运行测试套件

#### 性能优化
1. 分析模块性能瓶颈
2. 优化算法实现
3. 减少内存分配
4. 使用并行处理

### 🎉 总结

通过合理的模块化设计，我们实现了：
- **清晰的代码结构**
- **高效的开发流程**
- **良好的可维护性**
- **优秀的性能表现**

这种架构确保了代码的可读性、可维护性和可扩展性，为后续功能开发奠定了坚实的基础。
